---
- name: Configure SSH
  hosts: "{{ ansible_limit | default('nodes, !tpi') }}"
  gather_facts: false
  serial: 1
  tags: [ssh]
  tasks:
    # We are using the elaborate structure, tasks>block>task,
    # so that we can delegate to localhost and also access the
    # tpi name, because we might be dealing with multiple Turing PIs
    #
    # Furthermore, we are generating in /home/vscode in the container
    # this is due to the fact that we might be dealing with a devcontainer
    # on a Windows hosts, in this case we have an issue because the /usr/bin/attr
    # which is responsible for file attributes returns an error due to the fact
    # that the filesystem on Windows does not support this.
    # We are working around this because we NEED the generated SSH Key to be safely stored
    # on the host machine, so it is protected against any loss.
    - name: Generate SSH Keys
      delegate_to: localhost
      vars:
        tpi_name: "{{ hostvars[hostvars[inventory_hostname]['bmc']]['tpi']['name'] }}"
      block:
        - name: Check default user key
          ansible.builtin.stat:
            path: "{{ ssh.path }}/{{ tpi_name }}.{{ users.default }}.key"
          register: key_user_default

        - name: Check provision user key
          ansible.builtin.stat:
            path: "{{ ssh.path }}/{{ tpi_name }}.{{ users.default }}.key"
          register: key_user_provision

        - name: Generate SSH key "{{ tpi_name }}.{{ users.default }}" # noqa name[template]
          when: not key_user_default.stat.exists
          community.crypto.openssh_keypair:
            path: "/home/vscode/{{ tpi_name }}.{{ users.default }}.key"
            type: rsa
            size: "{{ ssh.bitsize }}"
            state: present
            force: false
            comment: "ansible"
            unsafe_writes: true

        - name: Private key permission
          when: not key_user_default.stat.exists
          ansible.builtin.file:
            path: "/home/vscode/{{ tpi_name }}.{{ users.default }}.key"
            mode: "0600"

        - name: Public key permission
          when: not key_user_default.stat.exists
          ansible.builtin.file:
            path: "/home/vscode/{{ tpi_name }}.{{ users.default }}.key.pub"
            mode: "0644"

        - name: Copy private key to host # noqa risky-file-permissions
          when: not key_user_default.stat.exists
          ansible.builtin.copy:
            src: "/home/vscode/{{ tpi_name }}.{{ users.default }}.key"
            dest: "{{ ssh.path }}/{{ tpi_name }}.{{ users.default }}.key"

        - name: Copy public key to host # noqa risky-file-permissions
          when: not key_user_default.stat.exists
          ansible.builtin.copy:
            src: "/home/vscode/{{ tpi_name }}.{{ users.default }}.key.pub"
            dest: "{{ ssh.path }}/{{ tpi_name }}.{{ users.default }}.key.pub"

        - name: Clean private key
          ansible.builtin.file:
            state: absent
            path: "/home/vscode/{{ tpi_name }}.{{ users.default }}.key"

        - name: Clean public key
          ansible.builtin.file:
            state: absent
            path: "/home/vscode/{{ tpi_name }}.{{ users.default }}.key.pub"

        # - name: Generate SSH key "{{ ssh_key_ubuntu }}"
        #   community.crypto.openssh_keypair:
        #     path: "{{ ssh.path }}/{{ tpi_name }}.{{ users.default }}.key"
        #     type: rsa
        #     size: "{{ ssh.bitsize }}"
        #     state: present
        #     force: false
        #     comment: "Deploy"

        # - name: Private key permission
        #   when: not is_windows_host.stdout_lines[0] | bool
        #   ansible.builtin.file:
        #     path: "{{ ssh.path }}/{{ tpi_name }}.{{ users.default }}.key"
        #     mode: "0600"

        # - name: Public key permission
        #   when: not is_windows_host.stdout_lines[0] | bool
        #   ansible.builtin.file:
        #     path: "{{ ssh.path }}/{{ tpi_name }}.{{ users.default }}.key.pub"
        #     mode: "0644"

---
- name: Bootstrap
  delegate_to: localhost
  block:
    - name: Power Off Node
      ansible.builtin.import_role:
        name: tpi
        tasks_from: power-off.yml

- name: Mount Storage
  tags: [bootstrap]
  ansible.builtin.import_role:
    name: tpi
    tasks_from: msd-mount.yml

- name: Generate cloud-init {{ inventory_hostname }}
  delegate_to: localhost
  ansible.builtin.template:
    src: cloud.cfg.j2
    dest: /tmp/tpi/cloud.cfg
    mode: "0644"
  vars:
    prefix: "{{ hostvars[hostvars[inventory_hostname]['bmc']]['ansible_ssh_prefix'] }}"

- name: Copy cloud-init to {{ inventory_hostname }}
  vars:
    src: /tmp/tpi/cloud.cfg
    dest: /mnt/node/etc/cloud/cloud.cfg
  ansible.builtin.import_role:
    name: tpi
    tasks_from: scp-send.yml

- name: Unmount Storage
  tags: [bootstrap]
  ansible.builtin.import_role:
    name: tpi
    tasks_from: msd-umount.yml

- name: TPI Client Wait
  ansible.builtin.pause:
    seconds: 1

- name: Power On Node
  ansible.builtin.import_role:
    name: tpi
    tasks_from: power-on.yml

- name: Bootup Node {{ inventory_hostname }}
  ansible.builtin.pause:
    seconds: 15

- name: Wait for {{ inventory_hostname }}
  delegate_to: localhost
  ansible.builtin.wait_for:
    host: "{{ hostvars[inventory_hostname]['ansible_host'] }}"
    port: 22
    search_regex: OpenSSH
    timeout: 120

- name: Add known_host
  vars:
    host: "{{ inventory_hostname }}"
    host_addr: "{{ hostvars[inventory_hostname]['ansible_host'] }}"
  ansible.builtin.include_role:
    name: ssh
    tasks_from: known_hosts.yml

- name: Add SSH config {{ inventory_hostname }}
  when: inventory_hostname in groups.nodes
  vars:
    host: "{{ inventory_hostname }}"
    hostname: "{{ hostvars[inventory_hostname]['ansible_host'] }}"
    username: "{{ users.default }}"
    key: "{{ hostvars[hostvars[inventory_hostname]['bmc']] }}.ubuntu.key"
  ansible.builtin.include_role:
    name: ssh
    tasks_from: config.yml

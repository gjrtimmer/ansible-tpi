# code: language=ansible
---
- name: Configure Nvidia
  when: hostvars[inventory_hostname]['type'] | upper == 'NVIDIA'
  vars:
    developer_preview: false
  block:
    - name: Install JetPack
      tags: [jetpack]
      ansible.builtin.import_tasks:
        file: jetpack.yml

    - name: Install Deeplearning Frameworks
      tags: [tensorflow, pytorch]
      ansible.builtin.import_tasks:
        file: deeplearning.yml

    - name: Check for Reboot
      ansible.builtin.stat:
        path: /var/run/reboot-required
        get_checksum: false
      register: reboot_required

    - name: Reboot Server
      throttle: 1
      ansible.builtin.reboot:
        msg: Reboot initiated by Ansible for Nvidia JetPack/Deeplearning install
        connect_timeout: 5
        reboot_timeout: 300
        pre_reboot_delay: 0
        post_reboot_delay: 30
        test_command: uptime
